rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Fonction pour vérifier si l'utilisateur est admin
    // Vérifie: 1. role='admin' en Firestore users/{uid} 2. UID hardcoded (fallback)
    // NOTE: Pas de Custom Claims (pas de Cloud Functions disponibles)
    function isAdmin() {
      return (request.auth != null && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
          || request.auth.uid == "D6QdYhxO71OCvYmZcrqqrpOHpyP2";
    }
    
    // ==================== USERS ====================
    // Collection des profils utilisateurs avec role
    // Structure: { email, role: 'admin'|'user'|'moderator', createdAt, updatedAt }
    match /users/{userId} {
      // Chacun peut lire son propre profil
      allow read: if request.auth.uid == userId;
      // Admin peut lire tous les profils
      allow read: if isAdmin();
      
      // Utilisateur crée son profil à l'inscription
      allow create: if request.auth.uid == userId &&
                       request.resource.data.role == 'user' &&
                       request.resource.data.email == request.auth.token.email;
      
      // Utilisateur peut mettre à jour son propre profil (sauf le role)
      allow update: if request.auth.uid == userId && 
                       !('role' in request.resource.data.diff().changedKeys());
      
      // Admin peut modifier les roles
      allow update: if isAdmin();
      
      // Admin peut supprimer
      allow delete: if isAdmin();
    }

    // ==================== AUDIT LOGS ====================
    // Collection d'audit pour tracer les actions admin
    // Structure: { uid, email, action, details, timestamp, success }
    match /admin_audit_logs/{logId} {
      // Admin peut lire tous les logs
      allow read: if isAdmin();
      
      // N'importe quel utilisateur authentifié peut créer un log
      // (le client-side valide le contenu)
      allow create: if request.auth != null &&
                       request.resource.data.keys().hasAll(['uid', 'email', 'action', 'timestamp']);
      
      // Admin peut supprimer les vieux logs (archivage)
      allow delete: if isAdmin();
      
      // Pas de modification (logs immuables)
      allow update: if false;
    }

    // ==================== PROJETS ====================
    // Les projets sont publics en lecture
    match /projets/{document=**} {
      allow read: if true;
      // Seulement l'admin peut créer/modifier/supprimer
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== COMMENTAIRES (PUBLICS IMMÉDIATEMENT) ====================
    // Les commentaires sont publics en lecture immédiatement
    match /comments/{document=**} {
      allow read: if true;
      // N'IMPORTE QUI peut créer des commentaires (pas d'authentification requise)
      allow create: if request.resource.data.keys().hasAll(['projectId', 'text']);
      // L'auteur peut éditer son commentaire pendant 15 min, admin peut aussi
      allow update: if (resource.data.userId == request.auth.uid && request.time < resource.data.date + duration.value(15, 'm')) || isAdmin();
      // L'auteur peut supprimer son commentaire, admin peut aussi
      allow delete: if resource.data.userId == request.auth.uid || isAdmin();
    }
    
    // ==================== TÉMOIGNAGES (MODÉRATION REQUISE) ====================
    // Les témoignages avec approved:true sont publics, les autres seulement par admin
    match /testimonials/{document=**} {
      allow read: if resource.data.approved == true || isAdmin();
      // N'IMPORTE QUI peut soumettre un avis (sans authentification)
      // Vérifie seulement que les 3 champs obligatoires sont présents
      allow create: if request.resource.data.keys().hasAll(['nom', 'texte', 'date']);
      // Seulement l'admin peut approuver/supprimer
      allow update, delete: if isAdmin();
    }
    
    // ==================== MESSAGES DE CONTACT (MODÉRATION REQUISE) ====================
    // Messages privés - seulement l'admin peut lire
    match /messages/{document=**} {
      allow read: if isAdmin();
      // N'IMPORTE QUI peut envoyer un message (sans authentification requise)
      allow create: if request.resource.data.keys().hasAll(['nom', 'email', 'message']);
      // Seulement l'admin peut modifier/supprimer
      allow delete: if isAdmin();
      allow update: if isAdmin();
    }
    
    // ==================== JOURNAL / ARTICLES ====================
    // Le journal est public en lecture
    match /journal/{document=**} {
      allow read: if true;
      // Seulement l'admin peut créer/modifier/supprimer
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== CONSEILS / TIPS ====================
    // Les conseils sont publics en lecture
    // Document structure: { titre: string, categorie: enum(os|hardware|security|network|software), 
    //                       difficulte: enum(debutant|intermediaire|avance), description: string, date: timestamp }
    match /tips/{document=**} {
      allow read: if true;
      // Seulement l'admin peut gérer
      allow create, update, delete: if isAdmin();
    }

    // ==================== CONFIG (GEMINI SETTINGS) ====================
    // Paramètres Gemini gérés par admin
    match /config/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ==================== À PROPOS ====================
    // Le contenu "À propos" est public en lecture
    // Document structure: { whoAmI: string, myJourney: string, photo: url }
    match /about/{document=**} {
      allow read: if true;
      // Seulement l'admin peut gérer
      allow create, update, delete: if isAdmin();
    }

    // ==================== STATISTIQUES ====================
    // Les statistiques sont publiques en lecture
    // Document structure: { projectsCount: number, clientsCount: number, yearsExperience: number }
    match /stats/{document=**} {
      allow read: if true;
      // Seulement l'admin peut gérer
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== CV-AUTOMATIQUE ====================
    // Sous-application de création de CV intégrée au portfolio
    
    // Profils utilisateurs avec plans et quotas
    match /cv_users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Documents CV appartenant aux utilisateurs
    match /cv_documents/{cvId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow create: if request.auth.uid != null && request.resource.data.userId == request.auth.uid;
      allow update: if resource.data.userId == request.auth.uid || isAdmin();
      allow delete: if resource.data.userId == request.auth.uid || isAdmin();
    }
    
    // Facturation et abonnements
    match /cv_billing/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow write: if isAdmin();
    }
    
    // Journal d'activités
    match /cv_activity/{docId} {
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      allow create: if request.auth.uid != null;
      allow delete: if isAdmin();
    }
    
    // ==================== RÈGLE PAR DÉFAUT ====================
    // Tout ce qui n'est pas spécifié est bloqué
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
